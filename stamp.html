<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>27mm Stamp Check-In</title>
  <style>
    body { font-family: system-ui, sans-serif; padding:16px; }
    #stage { width:100%; height:60vh; border:2px dashed #888; border-radius:8px; display:flex; align-items:center; justify-content:center; position:relative; touch-action:none; user-select:none; }
    #message { margin-top:12px; font-size:16px; }
    .dot { position:absolute; width:18px; height:18px; border-radius:50%; background:#222; transform:translate(-50%,-50%); opacity:0.8; pointer-events:none; }
    #success { color:green; font-weight:600; }
    #fail { color:#d33; }
  </style>
</head>
<body>

<h2>27 mm Stamp Check-In (Multi-Touch)</h2>

<div id="stage">Place your stamp or multiple fingers here</div>
<div id="message">
  <div id="result"></div>
  <div id="details"></div>
</div>

<script>
const targetDiameterMm = 27;  // Stamp size in mm
const toleranceMm = 2;        // ± tolerance
const stableTimeMs = 300;     // Time to hold for success
const minTouches = 2;         // Minimum touch points to trigger

const defaultPxPerMm = 96 / 25.4; // Approx 3.78 px/mm if not calibrated
let pxPerMm = null;  // Optional calibration

const stage = document.getElementById('stage');
const resultEl = document.getElementById('result');
const detailsEl = document.getElementById('details');

let activePointers = new Map();
let stableTimer = null;
let lastSuccessTime = 0;
const successCooldownMs = 1000;

function pxToMm(px) { return px / (pxPerMm || defaultPxPerMm); }

function showMsg(text, type='') {
  resultEl.textContent = text;
  resultEl.id = type === 'success' ? 'success' : (type === 'fail' ? 'fail' : '');
}

function showDetails(s) { detailsEl.textContent = s; }

function updateVisualDots() {
  document.querySelectorAll('.dot').forEach(el => el.remove());
  for (const [id, pt] of activePointers.entries()) {
    const dot = document.createElement('div');
    dot.className = 'dot';
    dot.style.left = pt.clientX + 'px';
    dot.style.top = pt.clientY + 'px';
    stage.appendChild(dot);
  }
}

function computeBoundingDiameterPx() {
  const pts = Array.from(activePointers.values());
  if (pts.length < 2) return 0;
  let maxd = 0;
  for (let i=0;i<pts.length;i++){
    for (let j=i+1;j<pts.length;j++){
      const dx = pts[i].clientX - pts[j].clientX;
      const dy = pts[i].clientY - pts[j].clientY;
      const d = Math.hypot(dx,dy);
      if (d > maxd) maxd = d;
    }
  }
  return maxd;
}

function evaluateStamp() {
  const touches = activePointers.size;
  if (touches < minTouches) {
    showMsg('Use multiple fingers or a stamp', 'fail');
    if (stableTimer) { clearTimeout(stableTimer); stableTimer=null; }
    return;
  }
  
  const diameterPx = computeBoundingDiameterPx();
  const diameterMm = pxToMm(diameterPx);

  showDetails(`Detected diameter: ${diameterMm.toFixed(2)} mm | Touch points: ${touches}`);
  
  const lower = targetDiameterMm - toleranceMm;
  const upper = targetDiameterMm + toleranceMm;
  const now = Date.now();

  if (diameterMm >= lower && diameterMm <= upper) {
    if (!stableTimer) {
      stableTimer = setTimeout(() => {
        if (Date.now() - lastSuccessTime < successCooldownMs) {
          showMsg('Recently checked in. Wait a moment.', '');
          stableTimer = null;
          return;
        }
        const diameterPx2 = computeBoundingDiameterPx();
        const diameterMm2 = pxToMm(diameterPx2);
        if (diameterMm2 >= lower && diameterMm2 <= upper) {
          lastSuccessTime = Date.now();
          showMsg('✅ Stamp check-in successful!', 'success');
          onStampSuccess({diameterMm: diameterMm2, touches});
        } else {
          showMsg('Hold steady to check-in.', 'fail');
        }
        stableTimer = null;
      }, stableTimeMs);
    } else {
      showMsg('Hold steady to complete check-in...', '');
    }
  } else {
    if (stableTimer) { clearTimeout(stableTimer); stableTimer = null; }
    showMsg('Stamp size not correct', 'fail');
  }
}

function onStampSuccess(info) {
  console.log('Stamp success', info);
  stage.style.borderColor = '#2b8a3e';
  setTimeout(()=> stage.style.borderColor = '#888', 600);
  // TODO: send to backend (Firebase/GitHub API) if needed
}

if (window.PointerEvent) {
  stage.addEventListener('pointerdown', e => {
    stage.setPointerCapture && stage.setPointerCapture(e.pointerId);
    activePointers.set(e.pointerId, {clientX:e.clientX, clientY:e.clientY});
    updateVisualDots();
    evaluateStamp();
  });
  stage.addEventListener('pointermove', e => {
    if (!activePointers.has(e.pointerId)) return;
    activePointers.set(e.pointerId, {clientX:e.clientX, clientY:e.clientY});
    updateVisualDots();
    evaluateStamp();
  });
  stage.addEventListener('pointerup', e => {
    activePointers.delete(e.pointerId);
    updateVisualDots();
    if (stableTimer) { clearTimeout(stableTimer); stableTimer=null; }
    evaluateStamp();
  });
  stage.addEventListener('pointercancel', e => {
    activePointers.delete(e.pointerId);
    updateVisualDots();
    if (stableTimer) { clearTimeout(stableTimer); stableTimer=null; }
    evaluateStamp();
  });
} else {
  // fallback to touch events
  stage.addEventListener('touchstart', e => {
    for (const t of Array.from(e.touches)) activePointers.set(t.identifier, {clientX:t.clientX, clientY:t.clientY});
    updateVisualDots();
    evaluateStamp();
    e.preventDefault();
  }, {passive:false});
  stage.addEventListener('touchmove', e => {
    for (const t of Array.from(e.touches)) activePointers.set(t.identifier, {clientX:t.clientX, clientY:t.clientY});
    updateVisualDots();
    evaluateStamp();
    e.preventDefault();
  }, {passive:false});
  stage.addEventListener('touchend', e => {
    const ids = new Set(Array.from(e.touches).map(t=>t.identifier));
    for (const id of Array.from(activePointers.keys())) if (!ids.has(id)) activePointers.delete(id);
    updateVisualDots();
    if (stableTimer) { clearTimeout(stableTimer); stableTimer=null; }
    evaluateStamp();
    e.preventDefault();
  }, {passive:false});
}

stage.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});

showMsg('Place your stamp or multiple fingers to check-in', '');
</script>

</body>
</html>
